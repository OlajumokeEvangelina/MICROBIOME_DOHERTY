---
title: "Microbiome Analysis"
output: pdf_document
author: "Olajumoke Evangelina Owokotomo"
date: "4/30/2019"
header-includes:
- \newcommand{\bcenter}{\begin{center}}
- \newcommand{\ecenter}{\end{center}}
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library("Biobase")
library("grid")
library("ggplot2")
library("nlme")
library(stringr)
library(dplyr)
library(phyloseq)
library(tidyr)
library(ggpubr)
library(gridExtra)
library(IntegratedJM)
```


```{r functionjm, echo=FALSE, message=FALSE, warning=FALSE,cache=TRUE}
JM = function(Mdata, Response , Covariates, MultTest){
  
  Response2 = as.vector(Response)
  Nmets <- as.numeric(nrow(Mdata))
  pearson <- spearman <- pValuePearson <- logratio <- AdjPearson  <-  c(1:Nmets) 
  Names <- rownames(Mdata)
  
  
  for (Nmet in 1:length(Names)) {
    print(Nmet)
    feature1 <-as.vector(Mdata[Nmet,])
    sampleID <- c(1:length(feature1)) 
    
    data <- data.frame(rbind(cbind(feature1, Covariates, sampleID), 
      cbind(Response2, Covariates,  sampleID)),
     respIndex = c(rep(1,length(feature1)),rep(2,length(Response2))))
    
    colnames(data) <- c("Responses", "myCov", "sampleID", 
                        "respIndex")
    
    #fit compound symmetry covariance structure
    f1 <- try( gls(Responses ~ myCov * as.factor(respIndex),
                   correlation = corSymm(form = ~ respIndex| sampleID),
                   weights = varIdent(form=~ 1|respIndex),
                   data = data, method = "ML"),silent=TRUE)
    
    
    #fit independence covariance structure
    f2 <- try(gls(Responses ~ myCov * as.factor(respIndex),
                  weights = varIdent(form=~ 1|respIndex),
                  data = data, method="ML"),silent=TRUE)
    
    #Likelihood Ratio Test
    LRT <- try(anova(f1,f2),silent=TRUE)
    logratio[Nmet] <- LRT[2,8]
    
    #compute for correlation coeffcients 
    pearson[Nmet] <- try(getVarCov(f1)[1,2]/(sqrt(getVarCov(f1)[1,1])*
                                                 sqrt(getVarCov(f1)[2,2]) ),silent=TRUE)
    
    pValuePearson[Nmet] <- try(as.numeric(LRT$"p-value"[2]), 
                                 silent=TRUE)             
    
    
    spearman[Nmet] <- cor(residuals(f1)[1:length(Response2)],
                            residuals(f1)[(length(Response2)+1):nrow(data)], 
                            method = "spearman")
    
    #adjust pValues
    AdjPearson[Nmet] <- p.adjust(pValuePearson[Nmet], method = MultTest, 
                           n = Nmets)
    
    
    result <- data.frame(pearson, pValuePearson, AdjPearson, spearman,logratio)
    
    colnames(result) <- c("rho","pvalue_rho", "pvalue_rho_adj"  ,"Spearman","logratio")
    rownames(result) <- Names
    
  }
  return(result)
}
```



## General information

* The dataset is a large phyloseq object saved as R datafile.

* The metadata has been converted to phyloseq format.

* The sample are Crohn's disease patients.

* The CDAI is the standard instrument for evaluating clinical symptoms and disease activity in Crohn's disease.

* Samples are randomized to take PlaceboIV or UstekinumabIV ni the trial.

* Taxonomic assignment of the OTU into 6 taxonomic ranks (Tax data) which are;
"Kingdom" "Phylum"  "Class"   "Order"   "Family"  "Genus".

* OTU Table contains 2353 taxa and 992 samples for all time point (OTU table).

* 83 information was obtained about the samples which includes their age, sex, race , country, treatment information, CDAI etc. 

* 306 samples information was obtained by baseline, 236 at week4, 261 at week 6 and 189 at week 22. No information about week 8.

* Difference in a subject’s initial Crohn’s disease activity index (CDAI) at baseline and other time point $\Delta_4 - \Delta_0$, $\Delta_6 - \Delta_0$, $\Delta_8 - \Delta_0$, $\Delta_{22} - \Delta_0$.

* Placebo samples were coded as 0 while treated samples were coded as 1.

\newpage

```{r first, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
load("C:/Users/lucp2490.LP2490-02/Desktop/EVANGELINA/PHD FOLDER/PHD/DEA/certifi_ori.rda")
OTU <- data.frame(certifi_ori@otu_table)
TAX <- data.frame(certifi_ori@tax_table)
SAMPEL <- data.frame(certifi_ori@sam_data)
SAMPEL$Treatment= ifelse(SAMPEL$TRTGR=="Placebo",0,1)



Screening_response <- SAMPEL %>% filter(visit == "Screening") %>% select(c("USUBJID", "AGE","SEX","RACE","COUNTRY","Treatment",
                "deltaCDAIwk0_22","deltaCDAIwk0_8","deltaCDAIwk0_6","deltaCDAIwk0_4","deltaCDAIwk8_22",
                "cdail_wk0","cdail_wk4","cdail_wk6","cdail_wk22","TRTGR"))


Week4_response <- SAMPEL %>% filter(visit == "Week 4") %>% select(c("USUBJID", "AGE","SEX","RACE","COUNTRY","Treatment",
              "deltaCDAIwk0_22","deltaCDAIwk0_8","deltaCDAIwk0_6","deltaCDAIwk0_4","deltaCDAIwk8_22",
              "cdail_wk0","cdail_wk4","cdail_wk6","cdail_wk22","TRTGR"))



Week6_response <- SAMPEL %>% filter(visit == "Week 6") %>% select(c("USUBJID", "AGE","SEX","RACE","COUNTRY","Treatment",
            "deltaCDAIwk0_22","deltaCDAIwk0_8","deltaCDAIwk0_6","deltaCDAIwk0_4","deltaCDAIwk8_22",
           "cdail_wk0","cdail_wk4","cdail_wk6","cdail_wk22","TRTGR"))



Week22_response <- SAMPEL %>% filter(visit == "Week 22") %>% select(c("USUBJID", "AGE","SEX","RACE","COUNTRY","Treatment",
                      "deltaCDAIwk0_22","deltaCDAIwk0_8","deltaCDAIwk0_6","deltaCDAIwk0_4","deltaCDAIwk8_22",
                      "cdail_wk0","cdail_wk4","cdail_wk6","cdail_wk22","TRTGR"))


otu = as.data.frame(t(OTU))
otu$visit = SAMPEL$visit
Screening_otu <- otu %>% filter(visit == "Screening") %>% select(-c("visit"))  %>% data.frame()
Week4_otu <- otu %>% filter(visit == "Week 4") %>% select(-c("visit"))  %>% data.frame()
Week6_otu <- otu %>% filter(visit == "Week 6") %>% select(-c("visit"))  %>% data.frame()
Week22_otu <- otu %>% filter(visit == "Week 22") %>% select(-c("visit"))  %>% data.frame()



freq_zero = data.frame(otunames = colnames(Week22_otu), Full_data = as.vector(apply(otu[,-2354] == 0, 2, sum)),
Screening = as.vector(apply(Screening_otu == 0, 2, sum)), week4 = as.vector(apply(Week4_otu == 0, 2, sum)),
week6 = as.vector(apply(Week6_otu == 0, 2, sum)), week22 = as.vector(apply(Week22_otu == 0, 2, sum)),
otunumber = 1:dim(Week4_otu)[2])

prop_zero = data.frame(otunames = colnames(Week22_otu), Full_data = freq_zero$Full_data/dim(otu)[1], Screening = freq_zero$Screening/dim(Screening_response)[1], 
                      week4 = freq_zero$week4/dim(Week4_otu)[1], week6 = freq_zero$week6/dim(Week6_otu)[1],
                      week22 = freq_zero$week22/dim(Week22_otu)[1],otunumber = 1:dim(Week4_otu)[2])


```

## Proportion of zero samples per OTU
### At all timepoints

```{r g1, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(prop_zero, aes(x=otunumber, y=Full_data)) +
  geom_point() + xlab("OTU number") +  theme_pubr() + ylab("Proportion of zero") +
  scale_y_continuous(breaks  = seq(0,1, by = 0.05))

```


### At week 0
```{r g2, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(prop_zero, aes(x=otunumber, y=Screening)) +
  geom_point() + xlab("OTU number") +  theme_pubr() + ylab("Proportion of zero")+
  scale_y_continuous(breaks  = seq(0,1, by = 0.05))

```


### At week 4
```{r g3, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(prop_zero, aes(x=otunumber, y=week4)) +
  geom_point() + xlab("OTU number") +  theme_pubr() + ylab("Proportion of zero")+
  scale_y_continuous(breaks  = seq(0,1, by = 0.05))

```



### At week 6
```{r g4, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(prop_zero, aes(x=otunumber, y=week6)) +
  geom_point() + xlab("OTU number") +  theme_pubr() + ylab("Proportion of zero")+
  scale_y_continuous(breaks  = seq(0,1, by = 0.05))

```



### At week 22
```{r g5, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(prop_zero, aes(x=otunumber, y=week22)) +
  geom_point() + xlab("OTU number") +  theme_pubr() + ylab("Proportion of zero")+
  scale_y_continuous(breaks  = seq(0,1, by = 0.05))

```



```{r second, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}

phy_week0 <- phyloseq(otu_table(t(Screening_otu), taxa_are_rows = TRUE), sample_data(Screening_response), tax_table(as.matrix(TAX)))

phy_week4 <- phyloseq(otu_table(t(Week4_otu), taxa_are_rows = TRUE), sample_data(Week4_response), tax_table(as.matrix(TAX)))

phy_week6 <- phyloseq(otu_table(t(Week6_otu), taxa_are_rows = TRUE), sample_data(Week6_response), tax_table(as.matrix(TAX)))

phy_week22 <- phyloseq(otu_table(t(Week22_otu), taxa_are_rows = TRUE), sample_data(Week22_response), tax_table(as.matrix(TAX)))

rich_week0 <- estimate_richness(phy_week0)
rich_week4 <- estimate_richness(phy_week4)
rich_week6 <- estimate_richness(phy_week6)
rich_week22 <- estimate_richness(phy_week22)

# The relative abundance of each OTU within each sample

relab_week0 = transform_sample_counts(phy_week0, function(x) x/sum(x))
relab_week4 = transform_sample_counts(phy_week4, function(x) x/sum(x))
relab_week6 = transform_sample_counts(phy_week6, function(x) x/sum(x))
relab_week22 = transform_sample_counts(phy_week22, function(x) x/sum(x))


pallzero <- data.frame(value = c(as.vector(length(which(apply(Screening_otu, 2, sum)==0))),as.vector(length(which(apply(Week4_otu, 2, sum)==0))),as.vector(length(which(apply(Week6_otu, 2, sum)==0))),as.vector(length(which(apply(Week22_otu, 2, sum)==0)))), Timepoint = c("Week0", "Week4", "Week6", "Week22"))
pallzero$prop <- pallzero$value/ dim(Screening_otu)[2]
pallzero$Timepoint <- factor(pallzero$Timepoint, levels = c("Week0","Week4","Week6","Week22"))

```

## Proportion of OTU per week with zero values for all sample
### All timepoints
```{r g6, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

ggplot(pallzero, aes(x=Timepoint, y=prop)) +
  geom_bar(stat = "identity") + xlab("") +  theme_pubr() + ylab("Proportion of zeros")

```

## Alpha-diversity plot
### Week 4
```{r g7, echo=FALSE,fig.width=14,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}
rich_week4$R1 <- Week4_response$deltaCDAIwk0_4
rich_week4$R2 <- Week4_response$cdail_wk4
rich_week4$Group <- Week4_response$TRTGR

p1 = ggplot(rich_week4, aes(x=Observed, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Observed richness") +  theme_pubr() + ylab("CDAI change from baseline")

p2 = ggplot(rich_week4, aes(x=Chao1, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Chao1 richness") +  theme_pubr() + ylab("CDAI change from baseline")

p3 = ggplot(rich_week4, aes(x=Shannon, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Shannon richness") +  theme_pubr() + ylab("CDAI change from baseline")

p4 = ggplot(rich_week4, aes(x=Simpson, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Simpson richness") +  theme_pubr() + ylab("CDAI change from baseline")

grid.arrange(p1, p2, nrow = 1)
grid.arrange(p3, p4, nrow = 1)

```


### Week 6
```{r g8, echo=FALSE,fig.width=14,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}
rich_week6$R1 <- Week6_response$deltaCDAIwk0_6
rich_week6$R2 <- Week6_response$cdail_wk6
rich_week6$Group <- Week6_response$TRTGR

p11 = ggplot(rich_week6, aes(x=Observed, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Observed richness") +  theme_pubr() + ylab("CDAI change from baseline")

p21 = ggplot(rich_week6, aes(x=Chao1, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Chao1 richness") +  theme_pubr() + ylab("CDAI change from baseline")

p31 = ggplot(rich_week6, aes(x=Shannon, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Shannon richness") +  theme_pubr() + ylab("CDAI change from baseline")

p41 = ggplot(rich_week6, aes(x=Simpson, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Simpson richness") +  theme_pubr() + ylab("CDAI change from baseline")

grid.arrange(p11, p21, nrow = 1)
grid.arrange(p31, p41, nrow = 1)

```


### Week 22
```{r g9, echo=FALSE,fig.width=14,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}
rich_week22$R1 <- Week22_response$deltaCDAIwk0_22
rich_week22$R2 <- Week22_response$cdail_wk22
rich_week22$Group <- Week22_response$TRTGR

a1 = ggplot(rich_week22, aes(x=Observed, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Observed richness") +  theme_pubr() + ylab("CDAI change from baseline")

a2 = ggplot(rich_week22, aes(x=Chao1, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Chao1 richness") +  theme_pubr() + ylab("CDAI change from baseline")

a3 = ggplot(rich_week22, aes(x=Shannon, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Shannon richness") +  theme_pubr() + ylab("CDAI change from baseline")

a4 = ggplot(rich_week22, aes(x=Simpson, y=R1, color = Group, shape = Group)) +
geom_point(size=3) + xlab("\u03b1-diversity = Simpson richness") +  theme_pubr() + ylab("CDAI change from baseline")

grid.arrange(a1, a2, nrow = 1)
grid.arrange(a3, a4, nrow = 1)

```

## Adjusted association from Joint modelling  (Response is CDAI change from baseline)
### Week 4
```{r adj1, echo=FALSE,fig.width=12,fig.height=7,fig.show='hold',fig.align='center', message=FALSE, warning=FALSE, cache=TRUE, warning=FALSE}

Response4 = Week4_response$deltaCDAIwk0_4
Treatment4 = Week4_response$Treatment
rich_week4new = rich_week4[,1:9]

adj_week4 = JM(t(rich_week4new), Response4 , Treatment4, MultTest="fdr")
adj_week4$measures = c("Obse" , "Chao1","se.chao1" ,"ACE" ,"se.ACE","Shann","Simps","InvSimps", "Fisher")
cutoff <- data.frame( x = c(-Inf, Inf), y = 0.05, cutoff = factor(0.05) )

ggplot(adj_week4, aes(x=measures, y=rho)) +
  geom_point(size=3) +  theme_pubr() + ylab(expression(rho)) + xlab("")

ggplot(adj_week4, aes(x=measures, y=pvalue_rho)) +
  geom_point(size=3) +  theme_pubr() + ylab("Unadjusted pvalues") + xlab("")+ 
  geom_line(aes( x, y, linetype = cutoff ), cutoff)

ggplot(adj_week4, aes(x=measures, y=pvalue_rho_adj)) +
  geom_point(size=3) +  theme_pubr() + ylab("Adjusted pvalues") + xlab("")+ 
  geom_line(aes( x, y, linetype = cutoff ), cutoff)


```